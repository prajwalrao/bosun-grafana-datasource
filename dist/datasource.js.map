{"version":3,"sources":["../src/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["import TableModel from 'app/core/table_model';\nimport moment from 'moment';\n\nexport class BosunDatasource {\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.annotateUrl = instanceSettings.jsonData.annotateUrl;\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n    }\n\n    makeTable(result) {\n        var table = new TableModel();\n        if (Object.keys(result).length < 1) {\n            return table;\n        }\n        var tagKeys = [];\n        _.each(result[0].Group, function (v, tagKey) {\n            tagKeys.push(tagKey);\n        });\n        tagKeys.sort();\n        table.columns = _.map(tagKeys, function (tagKey) {\n            return { \"text\": tagKey };\n        });\n        table.columns.push({ \"text\": \"value\" });\n        _.each(result, function (res) {\n            var row = [];\n            _.each(res.Group, function (tagValue, tagKey) {\n                row[tagKeys.indexOf(tagKey)] = tagValue;\n            });\n            row.push(res.Value);\n            table.rows.push(row);\n        });\n        return [table];\n    }\n\n    transformMetricData(result, target, options) {\n        var tagData = [];\n        _.each(result.Group, function (v, k) {\n            tagData.push({ 'value': v, 'key': k });\n        });\n        var sortedTags = _.sortBy(tagData, 'key');\n        var metricLabel = \"\";\n        if (target.alias) {\n            var scopedVars = _.clone(options.scopedVars || {});\n            _.each(sortedTags, function (value) {\n                scopedVars['tag_' + value.key] = { \"value\": value.value };\n            });\n            metricLabel = this.templateSrv.replace(target.alias, scopedVars);\n        } else {\n            tagData = [];\n            _.each(sortedTags, function (tag) {\n                tagData.push(tag.key + '=' + tag.value);\n            });\n            metricLabel = '{' + tagData.join(', ') + '}';\n        }\n        var dps = [];\n        _.each(result.Value, function (v, k) {\n            dps.push([v, parseInt(k) * 1000]);\n        });\n        return { target: metricLabel, datapoints: dps };\n    }\n\n    performTimeSeriesQuery(query, target, options) {\n        var exprDate = options.range.to.utc().format('YYYY-MM-DD');\n        var exprTime = options.range.to.utc().format('HH:mm:ss');\n        var url = this.url + '/api/expr?date=' + encodeURIComponent(exprDate) + '&time=' + encodeURIComponent(exprTime);\n        return this.backendSrv.datasourceRequest({\n            url: url,\n            method: 'POST',\n            data: query,\n            datasource: this\n        }).then(response => {\n            if (response.status === 200) {\n                var result;\n                if (response.data.Type === 'series') {\n                    result = _.map(response.data.Results, function (result) {\n                        return response.config.datasource.transformMetricData(result, target, options);\n                    });\n                }\n                if (response.data.Type === 'number') {\n                    result = response.config.datasource.makeTable(response.data.Results);\n                }\n                return { data: result };\n            }\n        });\n    }\n\n    query(options) {\n\n        var queries = [];\n        // Get time values to replace $start\n        // The end time is what bosun regards as 'now'\n        var secondsAgo = options.range.to.diff(options.range.from.utc(), 'seconds');\n        secondsAgo += 's';\n        _.each(options.targets, _.bind(function (target) {\n            if (!target.expr || target.hide) {\n                return;\n            }\n            var query = {};\n\n            query = this.templateSrv.replace(target.expr, options.scopedVars);\n            query = query.replace(/\\$start/g, secondsAgo);\n            query = query.replace(/\\$ds/g, options.interval);\n            queries.push(query);\n        }, this));\n\n        // No valid targets, return the empty result to save a round trip.\n        if (_.isEmpty(queries)) {\n            var d = this.q.defer();\n            d.resolve({ data: [] });\n            return d.promise;\n        }\n\n        var allQueryPromise = _.map(queries, _.bind(function (query, index) {\n            return this.performTimeSeriesQuery(query, options.targets[index], options);\n        }, this));\n\n        return this.q.all(allQueryPromise)\n            .then(function (allResponse) {\n                var result = [];\n                _.each(allResponse, function (response) {\n                    _.each(response.data, function (d) {\n                        result.push(d);\n                    });\n                });\n                return { data: result };\n            });\n    }\n\n    annotationQuery(options) {\n        var annotation = options.annotation;\n        var params = {};\n        params.StartDate = options.range.from.unix();\n        params.EndDate = options.range.to.unix();\n        if (annotation.Source) {\n            params.Source = annotation.Source;\n        }\n        if (annotation.Host) {\n            params.Host = annotation.Host;\n        }\n        if (annotation.CreationUser) {\n            params.CreationUser = annotation.CreationUser;\n        }\n        if (annotation.Owner) {\n            params.Owner = annotation.Owner;\n        }\n        if (annotation.Category) {\n            params.Category = annotation.Category;\n        }\n        if (annotation.Url) {\n            params.Url = annotation.Url;\n        }\n        if (annotation.Message) {\n            params.Message = annotation.Message;\n        }\n        var url = this.url + '/api/annotation/query?';\n        if (Object.keys(params).length > 0) {\n            url += jQuery.param(params);\n        }\n        var annotateUrl = this.annotateUrl;\n        return this.backendSrv.datasourceRequest({\n            url: url,\n            method: 'GET',\n            datasource: this\n        }).then(response => {\n            if (response.status === 200) {\n                var events = [];\n                _.each(response.data, (a) => {\n                    var text = [];\n                    if (a.Source) {\n                        text.push(\"Source: \"+a.Source);\n                    }\n                    if (a.Host) {\n                        text.push(\"Host: \"+a.Host);\n                    }\n                    if (a.CreationUser) {\n                        text.push(\"User: \"+a.User);\n                    }\n                    if (a.Owner) {\n                        text.push(\"Owner: \"+a.Owner);\n                    }\n                    if (a.Url) {\n                        text.push('<a href=\"' + a.Url + '\">' + a.Url.substring(0, 50) + '</a>');\n                    }\n                    if (a.Message) {\n                        text.push(a.Message);\n                    }\n                    text.push('<a href=\"' + annotateUrl + '/annotation' + '?id=' + encodeURIComponent(a.Id) + '\" target=\"_blank\">Edit this annotation</a>')\n                    var grafanaAnnotation = {\n                        annotation: annotation,\n                        time: moment(a.StartDate).utc().unix() * 1000,\n                        title: a.Category,\n                        text: text.join(\"<br>\")\n                    }\n                    events.push(grafanaAnnotation);\n                });\n                return events;\n            }\n        });\n    }\n\n    // Required\n    // Used for testing datasource in datasource configuration pange\n    testDatasource() {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/',\n            method: 'GET'\n        }).then(response => {\n            if (response.status === 200) {\n                return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n            }\n        });\n    }\n}\n\n"]}